{
    "$schema": "https://json-schema.org/draft/2020-12/schema",
    "$id": "https://sheratan.local/schemas/causal_snapshot_metadata_v1.0.schema.json",
    "title": "Causal Snapshot Metadata v1.0",
    "type": "object",
    "additionalProperties": false,
    "required": [
        "snapshot_version",
        "exported_at_iso",
        "target_metric",
        "t_ms",
        "breakdown_version",
        "spec_version",
        "app"
    ],
    "properties": {
        "snapshot_version": {
            "type": "string",
            "const": "causal_snapshot_v1.0"
        },
        "exported_at_iso": {
            "type": "string",
            "description": "UTC timestamp when snapshot was exported (ISO 8601).",
            "pattern": "^\\d{4}-\\d{2}-\\d{2}T\\d{2}:\\d{2}:\\d{2}(\\.\\d+)?Z$"
        },
        "target_metric": {
            "type": "string",
            "minLength": 1
        },
        "t_ms": {
            "type": "number"
        },
        "breakdown_version": {
            "type": "string",
            "description": "Causal breakdown payload version (e.g., 1.1).",
            "pattern": "^[0-9]+\\.[0-9]+$"
        },
        "spec_version": {
            "type": "string",
            "description": "Causal++ spec identifier (e.g., causal++_spec_v1).",
            "minLength": 1
        },
        "seed": {
            "type": [
                "number",
                "string",
                "null"
            ],
            "description": "Seed used for deterministic PRNG (Mulberry32).",
            "default": null
        },
        "prng": {
            "type": [
                "object",
                "null"
            ],
            "additionalProperties": false,
            "default": null,
            "properties": {
                "name": {
                    "type": "string",
                    "default": "mulberry32"
                },
                "variant": {
                    "type": [
                        "string",
                        "null"
                    ],
                    "default": null
                }
            }
        },
        "graph": {
            "type": [
                "object",
                "null"
            ],
            "additionalProperties": false,
            "default": null,
            "properties": {
                "path": {
                    "type": "string",
                    "default": "coupling-graph.json"
                },
                "sha256": {
                    "type": [
                        "string",
                        "null"
                    ],
                    "description": "Hex SHA256 of coupling-graph.json (optional but recommended).",
                    "pattern": "^[a-f0-9]{64}$"
                }
            }
        },
        "state": {
            "type": [
                "object",
                "null"
            ],
            "additionalProperties": false,
            "default": null,
            "properties": {
                "mode": {
                    "type": "string",
                    "enum": [
                        "full",
                        "targeted"
                    ],
                    "default": "full"
                },
                "path": {
                    "type": "string",
                    "default": "state.json"
                },
                "sha256": {
                    "type": [
                        "string",
                        "null"
                    ],
                    "pattern": "^[a-f0-9]{64}$"
                }
            }
        },
        "bundle": {
            "type": [
                "object",
                "null"
            ],
            "additionalProperties": false,
            "default": null,
            "properties": {
                "name": {
                    "type": [
                        "string",
                        "null"
                    ],
                    "default": null
                },
                "sha256": {
                    "type": [
                        "string",
                        "null"
                    ],
                    "description": "Hex SHA256 of the entire zip bytes (optional).",
                    "pattern": "^[a-f0-9]{64}$"
                }
            }
        },
        "app": {
            "type": "object",
            "additionalProperties": false,
            "required": [
                "name",
                "version"
            ],
            "properties": {
                "name": {
                    "type": "string",
                    "minLength": 1
                },
                "version": {
                    "type": "string",
                    "minLength": 1
                },
                "build_id": {
                    "type": [
                        "string",
                        "null"
                    ],
                    "default": null
                },
                "git_commit": {
                    "type": [
                        "string",
                        "null"
                    ],
                    "description": "Optional commit SHA if available at runtime.",
                    "pattern": "^[a-f0-9]{7,40}$"
                }
            }
        }
    }
}