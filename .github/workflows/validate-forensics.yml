name: Validate Forensics (Causal Breakdown v1.1)

on:
  push:
    paths:
      - "schemas/**"
      - "src/forensics/**"
      - "tools/**"
      - "tests/**"
      - "audit_exports/**"
      - "package.json"
      - "package-lock.json"
  pull_request:
    paths:
      - "schemas/**"
      - "src/forensics/**"
      - "tools/**"
      - "tests/**"
      - "audit_exports/**"
      - "package.json"
      - "package-lock.json"
  workflow_dispatch: {}

jobs:
  validate:
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install
        run: npm ci

      - name: Validate forensic exports
        shell: bash
        run: |
          set -euo pipefail

          # Collect candidate JSON files using find for robustness
          # De-duplicate to avoid double-validation
          files=()
          while IFS=  read -r -d $'\0'; do
              files+=("$REPLY")
          done < <(find tests audit_exports -maxdepth 2 -name "*.json" -print0 2>/dev/null | sort -uz)

          if [ ${#files[@]} -eq 0 ]; then
            echo "No forensic JSON files found. Skipping JSON validation."
          else
            echo "Validating ${#files[@]} files:"
            for f in "${files[@]}"; do
              echo " - $f"
              node tools/validate_breakdown.mjs "$f" --pretty
            done
          fi

          # Also validate ZIP bundles in audit_exports (robust check)
          echo "Validating ZIP bundles in audit_exports:"
          if [ -d audit_exports ]; then
            find audit_exports -maxdepth 2 -type f -name "*.zip" -print0 | while IFS= read -r -d '' z; do
              echo " - $z"
              node tools/validate_snapshot_bundle.mjs "$z" --pretty
            done
          else
            echo "Audit directory 'audit_exports' not present. Skipping ZIP validation."
          fi

      - name: Summary
        if: success()
        run: echo "âœ… All forensic exports validated against causal_breakdown v1.1"
