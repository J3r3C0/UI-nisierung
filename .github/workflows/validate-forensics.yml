name: Validate Forensics (Causal Breakdown v1.1)

on:
  push:
    paths:
      - "schemas/**"
      - "src/forensics/**"
      - "tools/**"
      - "tests/**"
      - "audit_exports/**"
      - "package.json"
      - "package-lock.json"
  pull_request:
    paths:
      - "schemas/**"
      - "src/forensics/**"
      - "tools/**"
      - "tests/**"
      - "audit_exports/**"
      - "package.json"
      - "package-lock.json"
  workflow_dispatch: {}

jobs:
  validate:
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install
        run: npm install

      - name: Validate forensic exports
        shell: bash
        run: |
          set -euo pipefail

          # Collect candidate JSON files
          files=$( (ls -1 tests/forensics/*.json 2>/dev/null || true; \
                    ls -1 tests/*.json 2>/dev/null || true; \
                    find audit_exports -type f -name "*.json" 2>/dev/null || true) | tr '\n' ' ' )

          if [ -z "${files// }" ]; then
            echo "No forensic JSON files found. Skipping."
            exit 0
          fi

          echo "Validating files:"
          for f in $files; do
            echo " - $f"
          done

          # Run validator per file
          for f in $files; do
            node tools/validate_breakdown.mjs "$f" --pretty
          done

      - name: Summary
        if: success()
        run: echo "âœ… All forensic exports validated against causal_breakdown v1.1"
