name: Validate Forensics (Causal Breakdown v1.1)

on:
  push:
    paths:
      - "schemas/**"
      - "src/forensics/**"
      - "tools/**"
      - "tests/**"
      - "audit_exports/**"
      - "package.json"
      - "package-lock.json"
  pull_request:
    paths:
      - "schemas/**"
      - "src/forensics/**"
      - "tools/**"
      - "tests/**"
      - "audit_exports/**"
      - "package.json"
      - "package-lock.json"
  workflow_dispatch: {}

jobs:
  validate:
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install
        run: npm ci

      - name: Validate forensic exports
        shell: bash
        run: |
          set -euo pipefail

          echo "Validating forensic JSON files…"
          files=$( (ls -1 tests/forensics/*.json 2>/dev/null || true) | sort -u )
          for f in $files; do
            echo " - $f"
            node tools/validate_breakdown.mjs "$f" --pretty
          done

          echo "Validating ZIP bundles in audit_exports…"

          if [ ! -d audit_exports ]; then
            echo "❗ audit_exports/ directory not found — skipping ZIP validation"
          else
            find audit_exports -type f -name "*.zip" -print0 | while IFS= read -r -d '' z; do
              echo " - $z"
              node tools/validate_snapshot_bundle.mjs "$z" --pretty
            done
          fi

      - name: Summary
        if: success()
        run: echo "✅ All forensic exports validated against causal_breakdown v1.1"
